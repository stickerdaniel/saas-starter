name: Sync PRs to Graphite

on:
  pull_request:
    types: [opened]
  workflow_dispatch:

jobs:
  sync-pr-to-graphite:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0 # Fetch full history for Graphite

      - name: Install Graphite CLI
        run: npm install -g @withgraphite/graphite-cli

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Authenticate with Graphite
        run: gt auth --token ${{ secrets.GRAPHITE_TOKEN }}

      - name: Create local main branch
        run: git branch main origin/main

      - name: Initialize Graphite
        run: gt init --trunk main

      - name: Track branch in Graphite
        run: gt track --parent main --force

      - name: Sync PR to Graphite
        run: gt submit --no-edit
